<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Codex Criminalis - Ελληνικός Ποινικός Κώδικας</title>
    
    <!-- PWA Meta Tags -->
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#3498db">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="Codex Criminalis">
    <link rel="apple-touch-icon" href="./icons/icon-192x192.png">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            position: relative;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            padding: 20px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .header .subtitle {
            font-size: 14px;
            opacity: 0.9;
        }

        .loading-section {
            padding: 40px 20px;
            text-align: center;
            background: #f8f9fa;
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            color: #7f8c8d;
            font-size: 16px;
        }

        .error-section {
            padding: 40px 20px;
            text-align: center;
            background: #fee;
            color: #c0392b;
        }

        .error-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .retry-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin-top: 15px;
        }

        .retry-btn:hover {
            background: #2980b9;
        }

        /* Original CSS continues here - copy from existing index.html */
        .search-section {
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }

        .search-container {
            position: relative;
            margin-bottom: 15px;
        }

        .search-dual {
            display: grid;
            grid-template-columns: 3fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .search-input {
            width: 100%;
            padding: 15px 50px 15px 20px;
            border: 2px solid #ddd;
            border-radius: 25px;
            font-size: 16px;
            outline: none;
            transition: all 0.3s ease;
        }

        .search-input:focus {
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .paragraph-input {
            height: 50px;
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.3s ease;
        }

        .paragraph-input:focus {
            border-color: #3498db;
        }

        .search-icon {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            color: #7f8c8d;
            font-size: 18px;
            pointer-events: none;
        }

        .search-modes {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .mode-btn {
            padding: 12px 20px;
            border: 2px solid #3498db;
            background: white;
            color: #3498db;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .mode-btn:hover {
            background: #f8f9fa;
        }

        .mode-btn.active {
            background: #3498db;
            color: white;
        }

        .browse-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .browse-btn {
            padding: 15px 20px;
            background: #34495e;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .browse-btn:hover {
            background: #2c3e50;
        }

        .main-content {
            padding: 20px;
            min-height: calc(100vh - 200px);
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        .home-view {
            text-align: center;
        }

        .welcome-message {
            font-size: 18px;
            color: #2c3e50;
            margin-bottom: 30px;
            line-height: 1.6;
        }

        .home-sections {
            display: grid;
            gap: 20px;
            margin-top: 30px;
        }

        .home-section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #dee2e6;
        }

        .home-section h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 16px;
        }

        .bookmark-item,
        .recent-item {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 12px 15px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .bookmark-item:hover,
        .recent-item:hover {
            background: #f8f9fa;
            border-color: #3498db;
        }

        .article-title {
            font-weight: 500;
            color: #2c3e50;
            margin-bottom: 2px;
        }

        .article-code {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 10px;
            color: white;
            font-weight: 500;
        }

        .article-code.PK {
            background: #e74c3c;
        }

        .article-code.KPD {
            background: #3498db;
        }

        .search-results {
            background: white;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #dee2e6;
        }

        .results-header {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #3498db;
        }

        .results-header h2 {
            color: #2c3e50;
            font-size: 18px;
        }

        .results-count {
            color: #7f8c8d;
            font-size: 14px;
            margin-top: 5px;
        }

        .search-result {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .search-result:hover {
            background: #f8f9fa;
            border-color: #3498db;
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .result-article {
            font-weight: 600;
            color: #2c3e50;
        }

        .result-code {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 10px;
            color: white;
        }

        .result-code.pk {
            background: #e74c3c;
        }

        .result-code.kpd {
            background: #3498db;
        }

        .result-title {
            font-weight: 500;
            color: #34495e;
            margin-bottom: 5px;
        }

        .result-snippet {
            color: #7f8c8d;
            font-size: 14px;
            line-height: 1.4;
        }

        .footer {
            background: #2c3e50;
            color: white;
            padding: 20px;
            text-align: center;
            margin-top: auto;
        }

        .footer-info {
            font-size: 12px;
            opacity: 0.8;
            margin-bottom: 10px;
        }

        .footer-copyright {
            font-size: 11px;
            opacity: 0.6;
        }

        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #2c3e50;
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 14px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .toast.show {
            opacity: 1;
        }

        @media (max-width: 768px) {
            .search-dual {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .browse-buttons {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 20px;
            }

            .main-content {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>Codex Criminalis</h1>
            <p class="subtitle">Ελληνικός Ποινικός Κώδικας & Κώδικας Ποινικής Δικονομίας</p>
        </header>

        <!-- Loading Section -->
        <div class="section" id="loadingSection">
            <div class="loading-section">
                <div class="loading-spinner"></div>
                <div class="loading-text">Φόρτωση δεδομένων...</div>
            </div>
        </div>

        <!-- Error Section -->
        <div class="section" id="errorSection">
            <div class="error-section">
                <div class="error-icon">⚠️</div>
                <h3>Σφάλμα φόρτωσης</h3>
                <p>Δεν ήταν δυνατή η φόρτωση των δεδομένων. Παρακαλώ ελέγξτε τη σύνδεσή σας.</p>
                <button class="retry-btn" onclick="app.loadData()">Επανάληψη</button>
            </div>
        </div>

        <!-- Search Section -->
        <div class="search-section" style="display: none;" id="searchInterface">
            <div class="search-container">
                <div class="search-dual">
                    <div style="position: relative;">
                        <input type="text" 
                               class="search-input" 
                               id="searchInput" 
                               placeholder="Αναζήτηση άρθρου ή κειμένου (π.χ. 299, απάτη)..."
                               autocomplete="off">
                        <span class="search-icon">🔍</span>
                    </div>
                    <input type="number" 
                           class="paragraph-input" 
                           id="paragraphInput" 
                           placeholder="Παρ."
                           min="1">
                </div>
                
                <div class="search-modes">
                    <button class="mode-btn active" onclick="app.setSearchMode('quick')">
                        ⚡ Γρήγορη Αναζήτηση
                    </button>
                    <button class="mode-btn" onclick="app.setSearchMode('extended')">
                        🔍 Εκτεταμένη Αναζήτηση
                    </button>
                </div>
                
                <div class="browse-buttons">
                    <button class="browse-btn" onclick="app.showBrowse('PK')">
                        📕 ΠΟΙΝΙΚΟΣ ΚΩΔΙΚΑΣ
                    </button>
                    <button class="browse-btn" onclick="app.showBrowse('KPD')">
                        📘 ΚΩΔΙΚΑΣ ΠΟΙΝΙΚΗΣ ΔΙΚΟΝΟΜΙΑΣ
                    </button>
                </div>
            </div>
        </div>

        <main class="main-content">
            <!-- Home Section -->
            <div class="section active" id="homeSection">
                <div class="home-view">
                    <div class="welcome-message">
                        Καλώς ήρθατε στον Codex Criminalis<br>
                        Γρήγορη πρόσβαση στον Ελληνικό Ποινικό Κώδικα και τον ΚΠΔ
                    </div>
                    
                    <div class="home-sections">
                        <div class="home-section">
                            <h3>⭐ Σελιδοδείκτες</h3>
                            <div id="bookmarksList">
                                <!-- Bookmarks will be populated here -->
                            </div>
                        </div>
                        
                        <div class="home-section">
                            <h3>🕒 Πρόσφατα</h3>
                            <div id="recentsList">
                                <!-- Recent articles will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Search Results Section -->
            <div class="section" id="searchSection">
                <div class="search-results" id="searchResults">
                    <!-- Results will be populated here -->
                </div>
            </div>

            <!-- Article View Section -->
            <div class="section" id="articleSection">
                <div id="articleView">
                    <!-- Article content will be populated here -->
                </div>
            </div>

            <!-- Browse Section -->
            <div class="section" id="browseSection">
                <div id="browseView">
                    <!-- Browse content will be populated here -->
                </div>
            </div>
        </main>

        <footer class="footer">
            <div class="footer-info">
                📅 Ενημερωμένη μέχρι: 15/03/2025 | 🏛️ Τελευταίος Ν.: 5089/2024
            </div>
            <div class="footer-copyright">
                © Dimitris Pavlidis
            </div>
        </footer>
    </div>

    <!-- Toast notification -->
    <div class="toast" id="toast"></div>

    <script>
        // Data Manager Class
        class DataManager {
            constructor() {
                this.data = {};
                this.loadingPromises = {};
            }

            async loadCode(codeType) {
                if (this.data[codeType]) {
                    return this.data[codeType];
                }

                if (this.loadingPromises[codeType]) {
                    return this.loadingPromises[codeType];
                }

                const fileName = codeType === 'PK' ? 'pk-sample.json' : 'kpd-sample.json';
                
                this.loadingPromises[codeType] = fetch(`data/${fileName}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        this.data[codeType] = data;
                        return data;
                    })
                    .catch(error => {
                        console.error(`Error loading ${codeType}:`, error);
                        delete this.loadingPromises[codeType];
                        throw error;
                    });

                return this.loadingPromises[codeType];
            }

            async loadAllData() {
                try {
                    await Promise.all([
                        this.loadCode('PK'),
                        this.loadCode('KPD')
                    ]);
                    return true;
                } catch (error) {
                    console.error('Error loading data:', error);
                    return false;
                }
            }

            getAllData() {
                return {
                    PK: this.data.PK || {},
                    KPD: this.data.KPD || {}
                };
            }
        }

        // Search functionality
        class CodexSearch {
            constructor(dataManager) {
                this.dataManager = dataManager;
                this.currentMode = 'quick';
                this.searchIndex = {};
                this.currentArticle = null;
                this.bookmarks = new Set(['386', '372', '282']); // Sample bookmarks
                this.recentArticles = ['375', '286']; // Sample recent articles
            }

            buildSearchIndex() {
                const allData = this.dataManager.getAllData();
                const index = {};
                
                // Index articles and content
                Object.keys(allData).forEach(codeType => {
                    if (allData[codeType]) {
                        Object.keys(allData[codeType]).forEach(articleNum => {
                            const article = allData[codeType][articleNum];
                            const key = `${articleNum}_${codeType}`;
                            
                            index[key] = {
                                article: articleNum,
                                code: codeType,
                                title: article.title,
                                text: article.text,
                                keywords: this.extractKeywords(article.title + ' ' + article.text)
                            };
                        });
                    }
                });
                
                this.searchIndex = index;
                return index;
            }

            extractKeywords(text) {
                return text.toLowerCase()
                    .replace(/[άάἀἁἂἃἄἅἆἇὰάᾀᾁᾂᾃᾄᾅᾆᾇᾰᾱᾲᾳᾴᾶᾷ]/g, 'α')
                    .replace(/[έέἐἑἒἓἔἕὲέ]/g, 'ε')
                    .replace(/[ήήἠἡἢἣἤἥἦἧὴήῂῃῄῆῇ]/g, 'η')
                    .replace(/[ίίἰἱἲἳἴἵἶἷὶίῒῖῗ]/g, 'ι')
                    .replace(/[όόὀὁὂὃὄὅὸό]/g, 'ο')
                    .replace(/[ύύὐὑὒὓὔὕὖὗὺύῢῦῧ]/g, 'υ')
                    .replace(/[ώώὠὡὢὣὤὥὦὧὼώῲῳῴῶῷ]/g, 'ω')
                    .split(/\s+/)
                    .filter(word => word.length > 2);
            }

            parseQuery(query) {
                query = query.trim();
                
                // Check if it's an article number search
                const articleMatch = query.match(/^(\d+)([αβγδΑΒΓΔ]?)\.?(\d+)?$/i);
                if (articleMatch) {
                    return {
                        type: 'article',
                        number: articleMatch[1] + (articleMatch[2] || ''),
                        paragraph: articleMatch[3] ? parseInt(articleMatch[3]) : null
                    };
                }
                
                // Text search
                return {
                    type: 'text',
                    keywords: this.extractKeywords(query)
                };
            }

            search(query, mode = 'quick') {
                if (!query.trim()) return [];

                const parsedQuery = this.parseQuery(query);
                let results = [];

                if (parsedQuery.type === 'article') {
                    results = this.searchByArticle(parsedQuery.number);
                } else {
                    results = this.searchByKeywords(parsedQuery.keywords, mode);
                }

                return results.slice(0, mode === 'quick' ? 10 : 50);
            }

            searchByArticle(articleNumber) {
                const allData = this.dataManager.getAllData();
                const results = [];
                
                Object.keys(allData).forEach(codeType => {
                    if (allData[codeType] && allData[codeType][articleNumber]) {
                        const article = allData[codeType][articleNumber];
                        results.push({
                            article: articleNumber,
                            code: codeType,
                            title: article.title,
                            text: article.text,
                            relevance: 100
                        });
                    }
                });
                
                return results;
            }

            searchByKeywords(keywords, mode) {
                if (keywords.length === 0) return [];
                
                const results = [];
                
                Object.values(this.searchIndex).forEach(entry => {
                    let relevance = 0;
                    
                    keywords.forEach(keyword => {
                        // Title match (higher weight)
                        if (entry.title.toLowerCase().includes(keyword)) {
                            relevance += 10;
                        }
                        
                        // Keyword match
                        if (entry.keywords.includes(keyword)) {
                            relevance += 5;
                        }
                        
                        // Text match (partial)
                        if (entry.text.toLowerCase().includes(keyword)) {
                            relevance += 2;
                        }
                    });
                    
                    if (relevance > 0) {
                        results.push({
                            ...entry,
                            relevance
                        });
                    }
                });
                
                return results.sort((a, b) => b.relevance - a.relevance);
            }
        }

        // Main Application Class
        class CodexApp {
            constructor() {
                this.dataManager = new DataManager();
                this.search = null;
                this.currentSection = 'home';
                this.init();
            }

            async init() {
                this.showSection('loading');
                
                try {
                    const success = await this.dataManager.loadAllData();
                    if (success) {
                        this.search = new CodexSearch(this.dataManager);
                        this.search.buildSearchIndex();
                        this.setupEventListeners();
                        this.populateHomeScreen();
                        this.showSection('home');
                        document.getElementById('searchInterface').style.display = 'block';
                    } else {
                        this.showSection('error');
                    }
                } catch (error) {
                    console.error('Initialization error:', error);
                    this.showSection('error');
                }
            }

            async loadData() {
                this.showSection('loading');
                await this.init();
            }

            setupEventListeners() {
                const searchInput = document.getElementById('searchInput');
                const paragraphInput = document.getElementById('paragraphInput');
                
                searchInput.addEventListener('input', (e) => {
                    if (e.target.value.trim()) {
                        this.performSearch(e.target.value, paragraphInput.value);
                    } else {
                        this.showSection('home');
                    }
                });

                searchInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.performSearch(searchInput.value, paragraphInput.value);
                    }
                });

                // Add click listeners for home items
                document.addEventListener('click', (e) => {
                    if (e.target.closest('.bookmark-item') || e.target.closest('.recent-item')) {
                        const item = e.target.closest('.bookmark-item') || e.target.closest('.recent-item');
                        const article = item.dataset.article;
                        const code = item.dataset.code;
                        if (article && code) {
                            this.showArticle(article, code);
                        }
                    }
                });
            }

            showSection(sectionName) {
                // Hide all sections
                document.querySelectorAll('.section').forEach(section => {
                    section.classList.remove('active');
                });
                
                // Show target section
                const targetSection = document.getElementById(sectionName + 'Section') || 
                                    document.getElementById(sectionName);
                if (targetSection) {
                    targetSection.classList.add('active');
                }
                
                this.currentSection = sectionName;
            }

            setSearchMode(mode) {
                this.search.currentMode = mode;
                
                // Update button states
                document.querySelectorAll('.mode-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                event.target.classList.add('active');
                
                // Re-run search if there's a current query
                const query = document.getElementById('searchInput').value;
                if (query.trim()) {
                    this.performSearch(query, document.getElementById('paragraphInput').value);
                }
            }

            performSearch(query, paragraph) {
                const results = this.search.search(query, this.search.currentMode);
                this.displaySearchResults(results, query, paragraph);
                this.showSection('search');
            }

            displaySearchResults(results, query, paragraph) {
                const searchResults = document.getElementById('searchResults');
                
                let html = `
                    <div class="results-header">
                        <h2>Αποτελέσματα αναζήτησης</h2>
                        <div class="results-count">
                            ${results.length} αποτελέσματα για "${query}"
                        </div>
                    </div>
                `;
                
                if (results.length === 0) {
                    html += `
                        <div style="text-align: center; padding: 40px; color: #7f8c8d;">
                            <div style="font-size: 48px; margin-bottom: 15px;">🔍</div>
                            <h3>Δεν βρέθηκαν αποτελέσματα</h3>
                            <p>Δοκιμάστε διαφορετικούς όρους αναζήτησης</p>
                        </div>
                    `;
                } else {
                    results.forEach(result => {
                        const snippet = result.text.length > 150 ? 
                            result.text.substring(0, 150) + '...' : result.text;
                        
                        html += `
                            <div class="search-result" onclick="app.showArticle('${result.article}', '${result.code}', ${paragraph || 'null'})">
                                <div class="result-header">
                                    <div class="result-article">Άρθρο ${result.article} ${result.code}</div>
                                    <div class="result-code ${result.code.toLowerCase()}">${result.code}</div>
                                </div>
                                <div class="result-title">${result.title}</div>
                                <div class="result-snippet">${snippet}</div>
                            </div>
                        `;
                    });
                }
                
                searchResults.innerHTML = html;
            }

            showArticle(articleNum, codeType, paragraph = null) {
                const allData = this.dataManager.getAllData();
                const article = allData[codeType][articleNum];
                
                if (!article) {
                    this.showToast('Το άρθρο δεν βρέθηκε');
                    return;
                }
                
                let html = `
                    <div style="background: white; border-radius: 12px; padding: 20px; border: 1px solid #dee2e6;">
                        <div style="border-bottom: 2px solid #3498db; padding-bottom: 15px; margin-bottom: 20px;">
                            <h2 style="color: #2c3e50; font-size: 20px; margin-bottom: 5px;">
                                Άρθρο ${articleNum} ${codeType}
                            </h2>
                            <div style="color: #7f8c8d; font-size: 16px; font-weight: 600;">
                                <span style="color: ${codeType === 'PK' ? '#e74c3c' : '#3498db'}">
                                    ${codeType === 'PK' ? '📕' : '📘'}
                                </span>
                                ${article.title}
                            </div>
                        </div>
                        
                        <div style="line-height: 1.6; font-size: 16px; color: #2c3e50;">
                `;
                
                if (article.paragraphs && article.paragraphs.length > 1) {
                    article.paragraphs.forEach((para, index) => {
                        const isHighlighted = paragraph && (index + 1) === parseInt(paragraph);
                        html += `
                            <div style="margin-bottom: 12px; padding: 8px 0; ${
                                isHighlighted ? 
                                'background: #fff3cd; border-left: 4px solid #ffc107; padding-left: 15px; margin-left: -15px; border-radius: 4px;' : 
                                ''
                            }">
                                <span style="font-weight: 600; color: #3498db; margin-right: 8px;">
                                    ${index + 1}.
                                </span>
                                ${para}
                            </div>
                        `;
                    });
                } else {
                    html += `<p>${article.text}</p>`;
                }
                
                html += `
                        </div>
                        
                        <div style="display: flex; gap: 10px; margin-top: 20px; padding-top: 15px; border-top: 1px solid #dee2e6; flex-wrap: wrap;">
                            <button style="padding: 8px 15px; border: 1px solid #ddd; background: white; border-radius: 6px; cursor: pointer; font-size: 14px;" 
                                    onclick="app.copyArticle('${articleNum}', '${codeType}')">
                                📋 Αντιγραφή
                            </button>
                            <button style="padding: 8px 15px; border: 1px solid #ddd; background: white; border-radius: 6px; cursor: pointer; font-size: 14px;" 
                                    onclick="app.shareArticle('${articleNum}', '${codeType}')">
                                📤 Κοινοποίηση
                            </button>
                            <button style="padding: 8px 15px; border: 1px solid #ddd; background: ${this.search.bookmarks.has(articleNum) ? '#3498db' : 'white'}; color: ${this.search.bookmarks.has(articleNum) ? 'white' : 'black'}; border-radius: 6px; cursor: pointer; font-size: 14px;" 
                                    onclick="app.toggleBookmark('${articleNum}', this)">
                                ${this.search.bookmarks.has(articleNum) ? '⭐' : '☆'} Σελιδοδείκτης
                            </button>
                        </div>
                    </div>
                `;
                
                document.getElementById('articleView').innerHTML = html;
                this.showSection('article');
                
                // Scroll to highlighted paragraph if specified
                if (paragraph) {
                    setTimeout(() => {
                        const highlighted = document.querySelector('[style*="background: #fff3cd"]');
                        if (highlighted) {
                            highlighted.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                    }, 100);
                }
            }

            populateHomeScreen() {
                this.populateBookmarks();
                this.populateRecents();
            }

            populateBookmarks() {
                const bookmarksList = document.getElementById('bookmarksList');
                const allData = this.dataManager.getAllData();
                
                let html = '';
                this.search.bookmarks.forEach(articleNum => {
                    // Find the article in either PK or KPD
                    let article = null;
                    let codeType = null;
                    
                    if (allData.PK && allData.PK[articleNum]) {
                        article = allData.PK[articleNum];
                        codeType = 'PK';
                    } else if (allData.KPD && allData.KPD[articleNum]) {
                        article = allData.KPD[articleNum];
                        codeType = 'KPD';
                    }
                    
                    if (article) {
                        html += `
                            <div class="bookmark-item" data-article="${articleNum}" data-code="${codeType}">
                                <div>
                                    <div class="article-title">Άρθρο ${articleNum} - ${article.title}</div>
                                </div>
                                <div class="article-code ${codeType}">${codeType}</div>
                            </div>
                        `;
                    }
                });
                
                if (html === '') {
                    html = '<p style="color: #7f8c8d; text-align: center; padding: 20px;">Δεν υπάρχουν σελιδοδείκτες</p>';
                }
                
                bookmarksList.innerHTML = html;
            }

            populateRecents() {
                const recentsList = document.getElementById('recentsList');
                const allData = this.dataManager.getAllData();
                
                let html = '';
                this.search.recentArticles.forEach(articleNum => {
                    // Find the article in either PK or KPD
                    let article = null;
                    let codeType = null;
                    
                    if (allData.PK && allData.PK[articleNum]) {
                        article = allData.PK[articleNum];
                        codeType = 'PK';
                    } else if (allData.KPD && allData.KPD[articleNum]) {
                        article = allData.KPD[articleNum];
                        codeType = 'KPD';
                    }
                    
                    if (article) {
                        html += `
                            <div class="recent-item" data-article="${articleNum}" data-code="${codeType}">
                                <div>
                                    <div class="article-title">Άρθρο ${articleNum} - ${article.title}</div>
                                </div>
                                <div class="article-code ${codeType}">${codeType}</div>
                            </div>
                        `;
                    }
                });
                
                if (html === '') {
                    html = '<p style="color: #7f8c8d; text-align: center; padding: 20px;">Δεν υπάρχουν πρόσφατα άρθρα</p>';
                }
                
                recentsList.innerHTML = html;
            }

            showBrowse(codeType) {
                const allData = this.dataManager.getAllData();
                const codeName = codeType === 'PK' ? 'Ποινικός Κώδικας' : 'Κώδικας Ποινικής Δικονομίας';
                const articles = Object.keys(allData[codeType] || {}).sort((a, b) => {
                    const parseArticle = (art) => {
                        const match = art.match(/^(\d+)([Α-Ω]?)$/);
                        if (match) {
                            return { num: parseInt(match[1]), letter: match[2] || '' };
                        }
                        return { num: parseInt(art), letter: '' };
                    };
                    
                    const aData = parseArticle(a);
                    const bData = parseArticle(b);
                    
                    if (aData.num !== bData.num) {
                        return aData.num - bData.num;
                    }
                    return aData.letter.localeCompare(bData.letter);
                });
                
                let html = `
                    <div style="background: white; border-radius: 12px; padding: 20px; border: 1px solid #dee2e6;">
                        <div style="margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #3498db;">
                            <h2 style="color: #2c3e50; font-size: 20px;">${codeName}</h2>
                        </div>
                        <div style="display: grid; gap: 8px;">
                `;
                
                articles.forEach(articleNum => {
                    const article = allData[codeType][articleNum];
                    const isBookmarked = this.search.bookmarks.has(articleNum);
                    
                    html += `
                        <div style="padding: 12px 15px; border: 1px solid #ddd; border-radius: 8px; cursor: pointer; transition: all 0.3s ease; display: flex; justify-content: space-between; align-items: center; background: white;" 
                             onclick="app.showArticle('${articleNum}', '${codeType}')"
                             onmouseover="this.style.background='#f8f9fa'; this.style.borderColor='#3498db'"
                             onmouseout="this.style.background='white'; this.style.borderColor='#ddd'">
                            <div>
                                <div style="font-weight: 600; color: #2c3e50; margin-bottom: 2px;">
                                    Άρθρο ${articleNum} ${isBookmarked ? '⭐' : ''}
                                </div>
                                <div style="font-size: 14px; color: #7f8c8d;">
                                    ${article.title}
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
                
                document.getElementById('browseView').innerHTML = html;
                this.showSection('browse');
            }

            copyArticle(articleNum, codeType) {
                const allData = this.dataManager.getAllData();
                const article = allData[codeType][articleNum];
                
                if (article) {
                    const text = `Άρθρο ${articleNum} ${codeType} - ${article.title}\n\n${article.text}`;
                    
                    if (navigator.clipboard) {
                        navigator.clipboard.writeText(text).then(() => {
                            this.showToast('Το άρθρο αντιγράφηκε');
                        });
                    } else {
                        // Fallback for older browsers
                        const textArea = document.createElement('textarea');
                        textArea.value = text;
                        document.body.appendChild(textArea);
                        textArea.select();
                        document.execCommand('copy');
                        document.body.removeChild(textArea);
                        this.showToast('Το άρθρο αντιγράφηκε');
                    }
                }
            }

            shareArticle(articleNum, codeType) {
                const allData = this.dataManager.getAllData();
                const article = allData[codeType][articleNum];
                
                if (article) {
                    const text = `Άρθρο ${articleNum} ${codeType} - ${article.title}\n\n${article.text}`;
                    const url = window.location.href;
                    
                    if (navigator.share) {
                        navigator.share({
                            title: `Άρθρο ${articleNum} ${codeType}`,
                            text: text,
                            url: url
                        });
                    } else {
                        // Fallback - copy to clipboard
                        this.copyArticle(articleNum, codeType);
                    }
                }
            }

            toggleBookmark(articleNum, buttonElement) {
                if (this.search.bookmarks.has(articleNum)) {
                    this.search.bookmarks.delete(articleNum);
                    buttonElement.style.background = 'white';
                    buttonElement.style.color = 'black';
                    buttonElement.innerHTML = '☆ Σελιδοδείκτης';
                    this.showToast('Αφαιρέθηκε από τους σελιδοδείκτες');
                } else {
                    this.search.bookmarks.add(articleNum);
                    buttonElement.style.background = '#3498db';
                    buttonElement.style.color = 'white';
                    buttonElement.innerHTML = '⭐ Σελιδοδείκτης';
                    this.showToast('Προστέθηκε στους σελιδοδείκτες');
                }
                
                // Update home screen bookmarks
                this.populateBookmarks();
            }

            showToast(message) {
                const toast = document.getElementById('toast');
                toast.textContent = message;
                toast.classList.add('show');
                
                setTimeout(() => {
                    toast.classList.remove('show');
                }, 3000);
            }
        }

        // Initialize the application
        const app = new CodexApp();

        // Register service worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then((registration) => {
                        console.log('SW registered: ', registration);
                    })
                    .catch((registrationError) => {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }
    </script>
</body>
</html>
